@model CarDealershipApp.ViewModels.CarViewModels.CarAddViewModel

@{
    ViewData["Title"] = "Add a New Car";
}

<h1>Add a New Car</h1>

<form asp-action="Add" method="post" enctype="multipart/form-data" id="addCarForm">
    @Html.AntiForgeryToken()

    <input asp-for="BrandId" type="hidden" />
    <input asp-for="SellerId" type="hidden" />

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="form-group">
        <label asp-for="ModelId">Model</label>
        <select asp-for="ModelId" asp-items="@(new SelectList(Model.Models ?? Enumerable.Empty<CarDealershipApp.Data.Models.Model>(), "Id", "Name"))" class="form-control">
            <option value="">-- Select a Model --</option>
        </select>
        <span asp-validation-for="ModelId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="CategoryId">Category</label>
        <select asp-for="CategoryId" asp-items="@(new SelectList(Model.Categories ?? Enumerable.Empty<CarDealershipApp.Data.Models.Category>(), "Id", "Name"))" class="form-control">
            <option value="">-- Select a Category --</option>
        </select>
        <span asp-validation-for="CategoryId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Price">Price</label>
        <input asp-for="Price" class="form-control" />
        <span asp-validation-for="Price" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Weight">Weight</label>
        <input asp-for="Weight" class="form-control" />
        <span asp-validation-for="Weight" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description">Description</label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Mileage">Mileage</label>
        <input asp-for="Mileage" class="form-control" />
        <span asp-validation-for="Mileage" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="ReleaseYear">Release Year</label>
        <input asp-for="ReleaseYear" type="number" class="form-control" />
        <span asp-validation-for="ReleaseYear" class="text-danger"></span>
    </div>

    <!-- File uploads only -->
    <div class="form-group">
        <label asp-for="Images">Upload Images (up to 4)</label>
        <input asp-for="Images" type="file" name="Images" multiple accept=".jpg,.jpeg,.png,.webp" class="form-control" />
        <small class="form-text text-muted">Accepted file types: .jpg, .jpeg, .png, .webp. Max size enforced on server.</small>
        <div id="images-error" class="text-danger mt-1" style="display:none;"></div>
    </div>

    <div class="form-group">
        <label>Features</label>
        @foreach (var feature in Model.AvailableFeatures ?? Enumerable.Empty<CarDealershipApp.Data.Models.Feature>())
        {
            <div class="form-check">
                <input type="checkbox"
                       class="form-check-input"
                       id="Feature_@feature.Id"
                       name="SelectedFeaturesIds"
                       value="@feature.Id"
                       @(Model.SelectedFeaturesIds != null && Model.SelectedFeaturesIds.Contains(feature.Id) ? "checked" : "") />
                <label class="form-check-label" for="Feature_@feature.Id">@feature.Name</label>
            </div>
        }
    </div>

    <button type="submit" class="btn btn-primary">Add Car</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const input = document.getElementById('Images');
            const err = document.getElementById('images-error');
            const form = document.getElementById('addCarForm');
            const allowedExt = ['jpg','jpeg','png','webp'];

            function validateFiles() {
                err.style.display = 'none';
                err.textContent = '';

                if (!input.files) return true;

                if (input.files.length > 4) {
                    err.style.display = 'block';
                    err.textContent = 'You can upload a maximum of 4 images.';
                    return false;
                }

                for (let i = 0; i < input.files.length; i++) {
                    const f = input.files[i];
                    const name = f.name.toLowerCase();
                    const ext = name.substring(name.lastIndexOf('.') + 1);
                    if (!allowedExt.includes(ext)) {
                        err.style.display = 'block';
                        err.textContent = 'One or more files have an invalid type.';
                        return false;
                    }
                }

                return true;
            }

            input.addEventListener('change', validateFiles);
            form.addEventListener('submit', function (e) {
                if (!validateFiles()) {
                    e.preventDefault();
                    return false;
                }
            });
        })();
    </script>
}
